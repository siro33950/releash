name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.new-version.outputs.version }}
      release-id: ${{ steps.release.outputs.release-id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest-tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Latest tag: $TAG"

      - name: Calculate new version
        id: new-version
        run: |
          LAST="${{ steps.latest-tag.outputs.tag }}"
          LAST="${LAST#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LAST"
          case "${{ inputs.bump }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac
          VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "New version: v$VERSION"

      - name: Create tag
        run: |
          git tag "v${{ steps.new-version.outputs.version }}"
          git push origin "v${{ steps.new-version.outputs.version }}"

      - name: Create release
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${{ steps.new-version.outputs.version }}`,
              name: `v${{ steps.new-version.outputs.version }}`,
              draft: false,
              generate_release_notes: true,
            });
            core.setOutput('release-id', data.id);

  build:
    needs: prepare
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: macos-universal

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.prepare.outputs.release-id }}
          tauriScript: pnpm tauri
          args: --target universal-apple-darwin --config '{"version":"${{ needs.prepare.outputs.version }}"}' -- --features vendored-openssl
